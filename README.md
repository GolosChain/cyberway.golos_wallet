# Документация для работы с сервисом cyberway.golos_wallet

## Пояснения

Golos_wallet -- сервис, который предоставляет улдобный API для взаимодействия с котрактом cyber.token, а также получать информацию по токенам, трансферам и балансам пользователей cyber.token.

Изначально кошелёк создавался как сервис для биржы Bittrex, который должен был 1 в 1 имитировать cli_wallet. cli_wallet -- консольная утилита для цепочки golos, имеющая возможность взаимодействия с ней через json-rpc интерфейс. Для этого нужно было прописать ключ -r и передать endpoint (пр. 127.0.0.1:2001).

Поэтому у кошелька по сути есть два подмножества методов: унаследованные от cli_wallet и новые, которые упрощаяют работу с cyber.token. Соответственно основное их внешнее различие в нотации:
первые -- `underscore_notation`, вторые -- `smallCamleCase`.

#### Особенности и ограничения хранения ключей и работы `import_key`

В текущей версии кодовой базы golos (20 hf) уже продолжительное время в cli_wallet есть возможность импортировать несколько приватных ключей, чтобы иметь возможность подписывать транзакции от лица разных аккаунтов, что несомненно является удобной и практичной функциональностью. К сожалению в данный момент хранение нескольких ключей в golos_wallet невозможно.

Причина этого в том, что golos_wallet вынужден поддерживать 100% внешнююю совместимость с cli_wallet. А именно import_key принимает в качестве аргумента только одну строку -- приватный ключ. Далле в cli_wallet в стейте хранится пара `publicKey => privateKey`. А при необходимости подписать транзакцию приватным ключом для аккаунта указанного в запросе выполняется  проход по списку сохраненнёх ключей и делается поиск по публичному ключу в базе по индексу `publicKey`, позволяющий по публичному ключу получить аккаунт, которому принадлежит этот публичный ключ. Соответсвенно, если публичный ключ обозначенного в запросе пользователя найден среди сохраненных ключей, то транзация подписывается его приватным ключом.

К сожалению в cyberway индекса для поиска аккаунта по публичному ключу нет. Страдайте :slighty_smiling_face: 

На текущей итерации развития cyberwaay это не критично, посколько единственный потребитель части кошелька с импортом ключа -- это биржа Bittrex. Кошелёк по факту нужен только как точка входа в mainnet cyberway. Используется только один аккаунт принадлежащий бирже, через который проводятся все транзакции. Вся логика с торгами между пользователями биржы остаётся на сервисе биржы.

#### Описание механики поддержки актуального состояния балансов пользователй в базе кошелька

Помимо возможности совершить трансфер, бирже необходимо предоставить способ получать историю трансферов и получать акутальный баланс пользователя. Именно по этой причине за основу сервиса golos_wallet был взят prism-service, который получая события от nats (очередь, в которую пишет EventEngine, плагин запущенный с нодой cyberway), разворачивает в mongodb копию стейта блокчейна cyberway.

В golos_wallet реализованы 2 модели -- `Transfer` и `Balance`. Их оказывается достаточно для хранения всего, что происходит со смарт-контрактом cyber.token. Для получения информации по трансферам и балансам реализованы соответствующие API-методы.

**TODO** в скором времени будет добавлена модель `Token` для сохранения всей информации о токенах, существующих в системе.

#### Формат запросов и ответов
Общение происходит по протоколу [JSON-RPC 2.0](https://www.jsonrpc.org/specification) с некоторыми более строгими
правилами:

- Параметры запроса должны только быть именованными, в виде JSON-объекта, безымянные не поддерживаются.
- Результат запроса в поле `result` всегда содержит JSON объект с результатом выполнения.
- В случае ошибки в поле `error` всегда содержится ответ формата `{"code": 123, "message": "Description text"}`,
  где `code` это цифровой код ошибки, описывающий тип проишествия, а `description` - текстовую ремарку для понимания
  ошибки человеком.
- RPC-нотификации работают как указано в стандарте, запросы без поля `id` не получают ответа, но сервер может
  их обработать по своему усмотрению.

Дополнительно стоит учитывать что сервер сам может передавать данные на клиент без получения запроса - например
так работает рассылка о событиях для пользователя, данные поступают через WebSocket со стороны сервера и
являются RPC-нотификациями, что не требует от клиента возвращать серверу какой-либо ответ.

## Что использует сервис

- MongoDB -- база для хранения информации по cyber.token
- Nats -- очередь, к которой можно подключиться для получения рассылки эвентов от EventEngine.

## Запуск сервиса

#### docker-compose
Для запуска сервиса достаточно вызвать команду `docker-compose up --build` в корне проекта, предварительно указав
необходимые `ENV` переменные.
Это запустит два контейнера: `wallet-mongo` и `wallet-node`

#### local way 
**TODO** 


## Инициализационные параметры

Для запуска сервиса необходимо в корень проекта положить `.env` файл. За основу можно взять `.env.example`.


Основные переменные окружения `ENV`:
  
 - `GLS_CONNECTOR_HOST` *(обязательно)* - адрес, который будет использован для входящих подключений связи микросервисов.  
  Дефолтное значение при запуске без докера - `127.0.0.1`

 - `GLS_CONNECTOR_PORT` *(обязательно)* - адрес порта, который будет использован для входящих подключений связи микросервисов.  
  Дефолтное значение при запуске без докера - `3000`

 - `GLS_METRICS_HOST` - адрес хоста для метрик StatsD.  
  Дефолтное значение при запуске без докера - `127.0.0.1`

 - `GLS_METRICS_PORT` - адрес порта для метрик StatsD.  
  Дефолтное значение при запуске без докера - `8125`
 
 - `GLS_BLOCKCHAIN_BROADCASTER_CONNECT` *(обязательно)* - адрес nats для получения эвентов от EventEngine подключенного к ноде cyberway

 - `GLS_MONGO_CONNECT` - строка подключения к базе MongoDB.  
  Дефолтное значение - `mongodb://mongo/admin`


## API

### getBalance
**Запрос ===>**

| Процедура  | Авторизация  | Описание                        |
|:----------:|:------------:|---------------------------------|
| getBalance | Не требуется | Получить баллансы пользователей |

| Параметр |  Тип   | Обяз. | Описание         |
|:--------:|:------:|:-----:|------------------|
|   name   | string |  Да   | Имя пользователя |

Пример:

Получаем баланс по всем токенам для пользователя `destroyer`

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "getBalance",
  "params": {
    "name": "destroyer"
  }
}
```

**<=== Ответ**
```json
{
  "jsonrpc": "2.0",
  "id": 991579,
  "result": {
    "name": "destroyer",
    "balances": [
      {
        "amount": 48,
        "decs": 3,
        "sym": "GLS"
      }
    ]
  }
}
```

**<=x= Ошибки**

| error code |            message            | Описание                                         |
|:----------:|:-----------------------------:|--------------------------------------------------|
|    809     |    Name must be a string!     | Передан некорректный параметр name               |
|    810     | Name can not be empty string! | Передана пустая строка в качестве параметра name |

---

### getHistory
**Запрос ===>**

| Процедура  | Авторизация  | Описание                                  |
|:----------:|:------------:|-------------------------------------------|
| getHistory | Не требуется | Получить историю трансферов пользователей |

|    Параметр    |  Тип   | Обяз. | Описание                                                                  |
|:--------------:|:------:|:-----:|---------------------------------------------------------------------------|
|     query      | object |  Да   | Фильтр для запросов. Обязательно должен быть указан хотя бы один параметр |
|  query.sender  | string |  Нет  | Имя отправителя трансфера                                                 |
| query.receiver | string |  Нет  | Имя получателя трансфера                                                  |

Пример:

Получаем все транзакции с отправителем `cyber.token` и получателем `korpusenko`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getHistory",
  "params": {
    "query": {
      "sender": "cyber.token",
      "receiver": "korpusenko"
    }
  }
}
```

**<=== Ответ**

Если трансферы соответствующие запросу существуют, то будет возващён массив объектов `TransferModel`, иначе пустой массив.

```json
{
  "jsonrpc": "2.0",
  "id": 488138,
  "result": {
    "transfers": [
      {
        "sender": "cyber.token",
        "receiver": "korpusenko",
        "quantity": {
          "amount": 10000,
          "decs": 4,
          "sym": "CUBE"
        }
      },
      {
        "sender": "cyber.token",
        "receiver": "korpusenko",
        "quantity": {
          "amount": 10000,
          "decs": 4,
          "sym": "QUAKE"
        }
      }
    ]
  }
}
```

**<=x= Ошибки**

| error code |     message     | Описание                          |
|:----------:|:---------------:|-----------------------------------|
|    805     | Wrong arguments | Передан некорректный объект query |

---

### filter_account_history
**Запрос ===>**

|       Процедура        | Авторизация  | Описание                                                                                                      |
|:----------------------:|:------------:|---------------------------------------------------------------------------------------------------------------|
| filter_account_history | Не требуется | Получить историю трансферов пользователя. Отличается от `getHistory` настройкой фильтров (как в `cli_wallet`) |

| Параметр |  Тип   | Обяз. | Описание                                                                                                                                                             |
|:--------:|:------:|:-----:|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| account  | string |  Да   | Имя пользователя                                                                                                                                                     |
|   from   | number |  Да   | Размер отступа от начала списка трансферов в базе. Значение `-1` указывает на конец списка                                                                           |
|  limit   | number |  Да   | Количество записей из списка трансферов. В паре с `limit` формирует отрезок запроса: `[begin, from]` размером `limit`. Не может быть больше `from`, если `from > -1` |
|  query   | object |  Да   | Фильтр для запросов. Обязательно должен быть указан хотя бы один параметр                                                                                            |

#### Параметры query

|      Параметр      |  Тип   | Обяз. | Описание                                                              |
|:------------------:|:------:|:-----:|-----------------------------------------------------------------------|
|     select_ops     | object |  Нет  | **Не реализовано**                                                    |
|     filter_ops     | object |  Нет  | **Не реализовано**                                                    |
|     direction      | object |  Нет  | Указывает роль `account` в трансфере                                  |
|  direction.sender  | object |  Нет  | Фильтрует только те трансферы, где отправитель `account`              |
| direction.receiver | object |  Нет  | Фильтрует только те трансферы, где получатель `account`               |
|   direction.dual   | object |  Нет  | Фильтрует только те трансферы, где отправитель и получатель `account` |
|  direction === {}  | object |  Нет  | Позволяет получить все трансферы, где фигурирует  `account`           |

Пример:

Получаем все транзакции с отправителем `cyber.token`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "filter_account_history",
  "params": [
    "cyber.token",
    -1,
    100,
    {}
  ]
}
```
**Или**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "filter_account_history",
  "params": {
    "account": "cyber.token",
    "from": -1,
    "limit": 100,
    "query": {}
  }
}
```


**<=== Ответ**

Если трансферы соответствующие запросу существуют, то будет возващён массив объектов `TransferModel`, иначе пустой массив.

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": [
    [
      0,
      {
        "block": 905226,
        "op": [
          "transfer",
          {
            "amount": "1.0000 GLS",
            "from": "cyber.token",
            "memo": "{}",
            "to": "korpusenko"
          }
        ],
        "timestamp": "2019-04-01T18:34:27.000",
        "trx_id": "551fd2f848bc32ee256c2880b2186b5307908448f37ca7850e09ef46142f5b9b"
      }
    ],
    [
      1,
      {
        "block": 905227,
        "op": [
          "transfer",
          {
            "amount": "2.0000 GLS",
            "from": "cyber.token",
            "memo": "{}",
            "to": "korpusenko"
          }
        ],
        "timestamp": "2019-04-01T18:34:30.000",
        "trx_id": "6619198ac252582755e641a743a1fe7663ec28b726180f21c50e1d4dd62af737"
      }
    ]
  ]
}
```

**<=x= Ошибки**

| error code |     message     | Описание                        |
|:----------:|:---------------:|---------------------------------|
|    805     | Wrong arguments | Переданы некорректные параметры |


---

### set_password
**Запрос ===>**

|  Процедура   |            Авторизация             | Описание                                                                                                                         |
|:------------:|:----------------------------------:|----------------------------------------------------------------------------------------------------------------------------------|
| set_password | Не требуется при отсутствии пароля | Установить новый пароль (мастер ключ) для кошелька. Кошелёк должен быть разблокирован, либо не иметь установленного ранее пароля |

Передаётся массив с одной строкой.

| Параметр |   Тип    | Обяз. | Описание                                               |
|:--------:|:--------:|:-----:|--------------------------------------------------------|
|  array   | string[] |  Да   | Массив содержащий ровно одну строку -- желаемый пароль |

**Или** объект с полем `password`


| Параметр |  Тип   | Обяз. | Описание        |
|:--------:|:------:|:-----:|-----------------|
| password | string |  Да   | Желаемый пароль |


Пример:

Устанавливаем надёжный пароль 

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "set_password",
  "params": ["12345qwerty"]
}
```


**ИЛИ**


```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "set_password",
  "params": {
    "password": "12345qwerty"
  }
}
```

**<=== Ответ**

При успешном вызове всегда результат будет `null`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": null
}
```

**<=x= Ошибки**

| error code |         message         | Описание                                                                            |
|:----------:|:-----------------------:|-------------------------------------------------------------------------------------|
|    803     | Wallet must be unlocked | Чтобы установить пароль требуется разблокировать кошелёк.                           |
|    804     |    Invalid password     | Пароль не может быть пустой строкой (хотя в cli_wallet может, и в steem, и в golos) |
|    805     |     Wrong arguments     | Передан некорректный аргумент. Нужен массив с одной непустой строкой внутри         |

---

### unlock
**Запрос ===>**

| Процедура | Авторизация  | Описание                                             |
|:---------:|:------------:|------------------------------------------------------|
|  unlock   | Не требуется | Разблокирует кошелёк с помощью пароля (мастер-ключа) |


Передаётся массив с одной строкой.

| Параметр |   Тип    | Обяз. | Описание                                      |
|:--------:|:--------:|:-----:|-----------------------------------------------|
|  array   | string[] |  Да   | Массив содержащий ровно одну строку -- пароль |



**Или** объект с полем `password`


| Параметр |  Тип   | Обяз. | Описание |
|:--------:|:------:|:-----:|----------|
| password | string |  Да   | Пароль   |

Пример:

Разблокируем кошелёк.

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "unlock",
  "params": ["12345qwerty"]
}
```


**ИЛИ**


```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "set_password",
  "params": {
    "password": "12345qwerty"
  }
}
```

**<=== Ответ**

При успешной разблокировке всегда будет возвращён `null`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": null
}
```

**<=x= Ошибки**

| error code |      message       | Описание                                                                     |
|:----------:|:------------------:|------------------------------------------------------------------------------|
|    801     | Set password first | Кошелёк не может быть разблокирован, поскольку пароль ещё не был установлен. |
|    804     |  Invalid password  | Пароль не может быть пустой строкой                                          |
|    805     |  Wrong arguments   | Передан некорректный аргумент. Нужен массив с одной непустой строкой внутри  |

---

### lock
**Запрос ===>**

| Процедура | Авторизация  | Описание          |
|:---------:|:------------:|-------------------|
|   lock    | Не требуется | Блокирует кошелёк |

| Параметр | Тип | Обяз. | Описание              |
|:--------:|:---:|:-----:|-----------------------|
|          |     |       | Не требует параметров |

Пример:

Заблокируем кошелёк.

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "lock"
}
```

**<=== Ответ**

При успешной блокировке всегда будет возвращён `null`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": null
}
```

**<=x= Ошибки**

| error code |      message       | Описание                                                                    |
|:----------:|:------------------:|-----------------------------------------------------------------------------|
|    801     | Set password first | Кошелёк не может быть заблокирован, поскольку пароль ещё не был установлен. |

---

### is_locked
**Запрос ===>**

| Процедура | Авторизация  | Описание                                            |
|:---------:|:------------:|-----------------------------------------------------|
| is_locked | Не требуется | Возвращает состояние кошелька: заблокирован или нет |

| Параметр | Тип | Обяз. | Описание              |
|:--------:|:---:|:-----:|-----------------------|
|          |     |       | Не требует параметров |

Пример:

Узнаем статус кошелька.

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "is_locked"
}
```

**<=== Ответ**

Всегда будет возвращёно `true` или `false`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": true
}
```

**<=x= Ошибки**

Нет

---

### import_key
**Запрос ===>**

| Процедура  | Авторизация | Описание                                                    |
|:----------:|:-----------:|-------------------------------------------------------------|
| import_key |  Требуется  | Импортирует новый ключ в кошелёк. Старый при этом теряется! |

Передаётся массив с одной строкой.

| Параметр |   Тип    | Обяз. | Описание                                                  |
|:--------:|:--------:|:-----:|-----------------------------------------------------------|
|  array   | string[] |  Да   | Массив содержащий ровно одну строку -- ключ в WIF формате |


**Или** объект с полем `key`


| Параметр |  Тип   | Обяз. | Описание           |
|:--------:|:------:|:-----:|--------------------|
|   key    | string |  Да   | ключ в WIF формате |

Пример:

Импортируем ключ.

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "unlock",
  "params": ["5HpHagT65TZzG1PH3CSu63k8DbpvD8s5ip4nEB3kEsreAbuatmU"]
}
```

**<=== Ответ**

При успешном импорте ключа всегда будет возвращён `null`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": null
}
```
**ИЛИ**

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "set_password",
  "params": {
    "key": "5HpHagT65TZzG1PH3CSu63k8DbpvD8s5ip4nEB3kEsreAbuatmU"
  }
}
```

**<=x= Ошибки**

| error code |         message         | Описание                                                                     |
|:----------:|:-----------------------:|------------------------------------------------------------------------------|
|    801     |   Set password first    | Кошелёк не может быть разблокирован, поскольку пароль ещё не был установлен. |
|    803     | Wallet must be unlocked | Чтобы испортировать ключ требуется разблокировать кошелёк.                   |
|    805     |     Wrong arguments     | Передан некорректный аргумент. Нужен массив с одной непустой строкой внутри  |

---

### transfer
**Запрос ===>**

| Процедура | Авторизация | Описание                                                                                                                                                                              |
|:---------:|:-----------:|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| transfer  |  Требуется  | Отправить трансфер от аккаунта `from` аккаунту `to` размером `amount`. Требует авторизации в кошелёк. **Требует импортированный приватный ключ, которым будут подписываться трансферы** |

| Параметр |  Тип   | Обяз. | Описание                                           |
|:--------:|:------:|:-----:|----------------------------------------------------|
|   from   | string |  Да   | Имя отправителя трансфера                          |
|    to    | string |  Да   | Имя получателя трансфера                           |
|  amount  | string |  Да   | asset string, размер перевода. Прим. `"1.000 GLS"` |
|   memo   | string |  Да   | object string, memo объект. Прим. `"{}"`           |

Пример:

Получаем все транзакции с отправителем `cyber.token`

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "transfer",
  "params": [
    "cyber.token",
    "destoyer",
    "42.0000 QUAKE",
    "{}"
  ]
}
```
**Или**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "transfer",
  "params": {
    "from": "cyber.token",
    "to": "destoyer",
    "amount": "42.0000 QUAKE",
    "memo": "{}"
  }
}
```

**<=== Ответ**
При успешом выполнении трансфера всегда будет возвращён `null`

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "result": null
}
```

**<=x= Ошибки**

| error code |             message              | Описание                                                   |
|:----------:|:--------------------------------:|------------------------------------------------------------|
|    803     |     Wallet must be unlocked      | Чтобы выполнить трансфер требуется разблокировать кошелёк. |
|    810     | A non-empty string was expected! | Передана пустая строка в качестве параметра name           |


---