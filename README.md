# Документация для работы с сервисом cyberway.golos_wallet

## Пояснения

Golos_wallet -- сервис, который предоставляет улдобный API для взаимодействия с котрактом cyber.token, а также получать информацию по токенам, трансферам и балансам пользователей cyber.token.

Изначально кошелёк создавался как сервис для биржы Bittrex, который должен был 1 в 1 имитировать cli_wallet. cli_wallet -- консольная утилита для цепочки golos, имеющая возможность взаимодействия с ней через json-rpc интерфейс. Для этого нужно было прописать ключ -r и передать endpoint (пр. 127.0.0.1:2001).

Поэтому у кошелька по сути есть два подмножества методов: унаследованные от cli_wallet и новые, которые упрощаяют работу с cyber.token. Соответственно основное их внешнее различие в нотации:
первые -- `underscore_notation`, вторые -- `smallCamleCase`.

#### Особенности и ограничения хранения ключей и работы `import_key`

В текущей версии кодовой базы golos (20 hf) уже продолжительное время в cli_wallet есть возможность импортировать несколько приватных ключей, чтобы иметь возможность подписывать транзакции от лица разных аккаунтов, что несомненно является удобной и практичной функциональностью. К сожалению в данный момент хранение нескольких ключей в golos_wallet невозможно.

Причина этого в том, что golos_wallet вынужден поддерживать 100% внешнююю совместимость с cli_wallet. А именно import_key принимает в качестве аргумента только одну строку -- приватный ключ. Далле в cli_wallet в стейте хранится пара `publicKey => privateKey`. А при необходимости подписать транзакцию приватным ключом для аккаунта указанного в запросе выполняется  проход по списку сохраненнёх ключей и делается поиск по публичному ключу в базе по индексу `publicKey`, позволяющий по публичному ключу получить аккаунт, которому принадлежит этот публичный ключ. Соответсвенно, если публичный ключ обозначенного в запросе пользователя найден среди сохраненных ключей, то транзация подписывается его приватным ключом.

К сожалению в cyberway индекса для поиска аккаунта по публичному ключу нет. Страдайте :slighty_smiling_face: 

На текущей итерации развития cyberwaay это не критично, посколько единственный потребитель части кошелька с импортом ключа -- это биржа Bittrex. Кошелёк по факту нужен только как точка входа в mainnet cyberway. Используется только один аккаунт принадлежащий бирже, через который проводятся все транзакции. Вся логика с торгами между пользователями биржы остаётся на сервисе биржы.

#### Описание механики поддержки актуального состояния балансов пользователй в базе кошелька

Помимо возможности совершить трансфер, бирже необходимо предоставить способ получать историю трансферов и получать акутальный баланс пользователя. Именно по этой причине за основу сервиса golos_wallet был взят prism-service, который получая события от nats (очередь, в которую пишет EventEngine, плагин запущенный с нодой cyberway), разворачивает в mongodb копию стейта блокчейна cyberway.

В golos_wallet реализованы 2 модели -- `Transfer` и `Balance`. Их оказывается достаточно для хранения всего, что происходит со смарт-контрактом cyber.token. Для получения информации по трансферам и балансам реализованы соответствующие API-методы.

**TODO** в скором времени будет добавлена модель `Token` для сохранения всей информации о токенах, существующих в системе.

#### Формат запросов и ответов
Общение происходит по протоколу [JSON-RPC 2.0](https://www.jsonrpc.org/specification) с некоторыми более строгими
правилами:

- Параметры запроса должны только быть именованными, в виде JSON-объекта, безымянные не поддерживаются.
- Результат запроса в поле `result` всегда содержит JSON объект с результатом выполнения.
- В случае ошибки в поле `error` всегда содержится ответ формата `{"code": 123, "message": "Description text"}`,
  где `code` это цифровой код ошибки, описывающий тип проишествия, а `description` - текстовую ремарку для понимания
  ошибки человеком.
- RPC-нотификации работают как указано в стандарте, запросы без поля `id` не получают ответа, но сервер может
  их обработать по своему усмотрению.

Дополнительно стоит учитывать что сервер сам может передавать данные на клиент без получения запроса - например
так работает рассылка о событиях для пользователя, данные поступают через WebSocket со стороны сервера и
являются RPC-нотификациями, что не требует от клиента возвращать серверу какой-либо ответ.


## API

### getBalance
**Запрос ===>**

|       Процедура       | Авторизация  | Описание                                  |
| :-------------------: | :----------: | ----------------------------------------- |
|        getBalance     | Не требуется | Получить баллансы пользователей           |

| Параметр |  Тип   | Обяз. | Описание         |
| :------: | :----: | :---: | ---------------- |
|   name   | string |  Да   | Имя пользователя |

Пример:

Получаем состояние регистрации для пользователя

```json
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "getBalance",
  "params": {
    "name": "destroyer"
  }
}
```

**<=== Ответ**

_Не описан..._

**<=x= Ошибки**

_Не описаны..._

---
